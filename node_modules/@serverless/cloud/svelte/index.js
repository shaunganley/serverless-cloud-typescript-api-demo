const { join } = require('path')

module.exports.kit = {
  methodOverride: {
    allowed: ['PUT', 'PATCH', 'DELETE']
  },
  vite: {
    build: {
      rollupOptions: {
        external: ['@serverless/cloud']
      }
    }
  },
  // hydrate the <div id="svelte"> element in src/app.html
  target: '#svelte',
  files: {
    assets: 'src/assets'
  },
  adapter: {
    name: '@serverless/cloud',
    async adapt(builder) {
      const dest = join('.svelte-kit', 'output', 'prerendered')

      builder.rimraf(dest)

      await builder.prerender({ dest })

      const svelte = 'svelte'

      builder.rimraf(svelte)
      builder.writeServer(svelte)
      builder.copy(join(__dirname, 'shim.js'), join(svelte, 'index.js'))

      const static_ = 'static'

      builder.rimraf(static_)
      builder.copy(dest, static_)
      builder.writeStatic(static_)
      builder.writeClient(static_)
    }
  }
}
