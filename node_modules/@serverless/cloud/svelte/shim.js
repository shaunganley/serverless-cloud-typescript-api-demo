// eslint-disable
import { getRequest, setResponse } from '@sveltejs/kit/node'
import { fetch, Response, Request, Headers } from '@sveltejs/kit/install-fetch'

global.fetch = fetch
global.Response = Response
global.Request = Request
global.Headers = Headers

import { App } from './app.js'
import { manifest } from './manifest.js'

const app = new App(manifest)

export default async function (req, res, next) {
  let request
  const origin = `https://${req.headers.host}`
  try {
    request = await getRequest(origin, req)
  } catch (err) {
    res.statusCode = err.status || 400
    return res.end(err.reason || 'Invalid request body')
  }

  const rendered = await app.render(request)

  if (rendered) {
    setResponse(res, rendered)
  } else {
    next()
  }
}
